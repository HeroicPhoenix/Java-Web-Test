<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <title>TRPG 控制台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        :root{
            --primary:#2563eb; --border:#e5e7eb; --muted:#6b7280; --bg:#fafafa; --danger:#b91c1c;
        }
        html,body{height:100%}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;color:#111827}
        header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
        h1{font-size:20px;margin:0}
        main{padding:20px;max-width:1280px;margin:0 auto}
        .toolbar{display:flex;gap:8px;flex-wrap:wrap}
        button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer;transition:.15s}
        button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
        button.danger{border-color:var(--danger);color:var(--danger)}
        button.small{padding:6px 8px;font-size:12px;border-radius:8px}
        .grid{display:grid;gap:20px;grid-template-columns:repeat(12,1fr)}
        .card{grid-column:span 12;border:1px solid var(--border);border-radius:14px;padding:16px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04)}
        @media (min-width: 1100px){
            #playerCard{grid-column:span 6}
            #roomCard{grid-column:span 6}
            #roomDetail{grid-column:span 12}
        }
        .card h2{margin:0 0 10px 0;font-size:18px}
        .right{display:flex;gap:8px;align-items:center}
        .muted{color:var(--muted)}
        .pager{display:flex;gap:6px;align-items:center;margin:8px 0 10px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
        th{background:var(--bg)}
        tr.selectable{cursor:pointer}
        tr.active{background:#eef2ff}
        dialog{border:none;border-radius:16px;padding:18px;max-width:560px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,.25)}
        dialog::backdrop{background:rgba(0,0,0,.3)}
        dialog form{display:flex;flex-direction:column;gap:10px}
        label{display:flex;flex-direction:column;gap:6px;font-size:14px}
        input[type="text"], input[type="number"]{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px}
        .row{display:flex;gap:10px}
        .row > *{flex:1}
        .gridbox{border:1px solid var(--border);border-radius:12px;padding:8px;max-height:260px;overflow:auto;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
        .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
        .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;padding:10px 14px;border-radius:10px;background:#111827;color:#fff;font-size:14px;opacity:0;pointer-events:none;transition:.25s;z-index:50}
        .toast.show{opacity:1}
    </style>
</head>
<body>
<header>
    <h1>TRPG 控制台</h1>
    <div class="toolbar">
        <button class="primary" id="btnCreatePlayer">创建玩家</button>
        <button class="primary" id="btnCreateRoom">创建房间</button>
        <button id="btnRefresh">刷新全部</button>
        <button id="btnSettings">设置</button>
    </div>
</header>

<main>
    <div class="grid">
        <!-- 玩家列表 -->
        <section class="card" id="playerCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h2>玩家</h2>
                <div class="right">
                    <button id="pPrev">上一页</button>
                    <span class="muted" id="pInfo">第 1/1 页，共 0 条</span>
                    <button id="pNext">下一页</button>
                    <button id="pRefresh">刷新</button>
                </div>
            </div>
            <table id="playerTable">
                <thead>
                <tr>
                    <th style="width:56px">#</th>
                    <th>player_id</th>
                    <th>玩家名称</th>
                    <th>创建时间</th>
                    <th style="width:160px">操作</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- 房间列表 -->
        <section class="card" id="roomCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h2>房间</h2>
                <div class="right">
                    <button id="rPrev">上一页</button>
                    <span class="muted" id="rInfo">第 1/1 页，共 0 条</span>
                    <button id="rNext">下一页</button>
                    <button id="rRefresh">刷新</button>
                </div>
            </div>
            <table id="roomTable">
                <thead>
                <tr>
                    <th style="width:56px">#</th>
                    <th>room_id</th>
                    <th>房间名称</th>
                    <th>地图尺寸</th>
                    <th>回合</th>
                    <th>战斗中</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="muted" style="margin-top:6px">点击上表任意一行以选择房间并管理成员</div>
        </section>

        <!-- 房间详情（选中房间后显示） -->
        <section class="card" id="roomDetail" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h2>房间详情</h2>
                <div class="right">
                    <span class="muted">room_id：</span><span id="selRoomId" class="muted"></span>
                </div>
            </div>
            <div style="margin:6px 0 10px 0">
                <div><b>房间名称：</b><span id="selRoomName"></span></div>
                <div class="muted" style="margin-top:4px">
                    地图：<span id="selRoomSize"></span>，
                    回合：<span id="selRoomRounds"></span>，
                    战斗中：<span id="selRoomBattle"></span>
                </div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <h3 style="margin:0;font-size:16px">成员</h3>
                <div class="right">
                    <button id="btnAddMembers" class="primary small">添加玩家到此房间</button>
                    <button id="btnReloadMembers" class="small">刷新成员</button>
                </div>
            </div>
            <table id="roomMembersTable" style="margin-top:8px">
                <thead>
                <tr>
                    <th style="width:56px">#</th>
                    <th>player_id</th>
                    <th>玩家名称</th>
                    <th>加入时间</th>
                    <th style="width:120px">操作</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>
</main>

<!-- 创建玩家 -->
<dialog id="dlgPlayer">
    <form method="dialog" id="formPlayer" novalidate>
        <h3 style="margin:0 0 6px 0">创建玩家</h3>
        <label>玩家名称
            <input type="text" id="playerName" maxlength="100" placeholder="输入玩家名称" required>
        </label>
        <div class="actions">
            <button value="cancel">取消</button>
            <button class="primary" value="ok">创建</button>
        </div>
    </form>
</dialog>

<!-- 创建房间 -->
<dialog id="dlgRoom">
    <form method="dialog" id="formRoom" novalidate>
        <h3 style="margin:0 0 6px 0">创建房间</h3>
        <label>房间名称
            <input type="text" id="roomName" maxlength="100" placeholder="例如：新手村一号房" required>
        </label>
        <div class="row">
            <label>地图尺寸 X
                <input type="number" id="mapX" min="1" value="10" required>
            </label>
            <label>地图尺寸 Y
                <input type="number" id="mapY" min="1" value="10" required>
            </label>
        </div>
        <div>
            <div style="margin:6px 0 4px 0">选择加入的玩家（可多选）</div>
            <div class="gridbox" id="playerGrid"></div>
        </div>
        <div class="actions">
            <button value="cancel">取消</button>
            <button class="primary" value="ok">创建</button>
        </div>
    </form>
</dialog>

<!-- 向房间添加成员 -->
<dialog id="dlgAddMembers">
    <form method="dialog" novalidate>
        <h3 style="margin:0 0 6px 0">添加玩家到房间</h3>
        <div class="gridbox" id="addMemberGrid"></div>
        <div class="actions">
            <button value="cancel">取消</button>
            <button class="primary" value="ok">添加</button>
        </div>
    </form>
</dialog>

<!-- 设置 -->
<dialog id="dlgSettings">
    <form method="dialog" novalidate>
        <h3 style="margin:0 0 6px 0">系统设置</h3>
        <p class="muted" style="margin:0 0 12px 0">点击按钮可导出当前配置表为 SQLite 数据库 (data.db)。</p>
        <div class="actions">
            <button type="button" class="primary" id="btnDownloadConfig">获取配置文件</button>
            <button value="cancel">关闭</button>
        </div>
    </form>
</dialog>

<div class="toast" id="toast"></div>

<script>
    /* ===== 工具 & API ===== */
    const $ = sel => document.querySelector(sel);
    async function j(r){
        if(!r.ok){
            let msg = `HTTP ${r.status}`;
            try{
                const ct = r.headers.get('content-type') || '';
                if(ct.includes('application/json')){
                    const data = await r.json();
                    msg += ': ' + (data.message || data.error || JSON.stringify(data));
                }else{
                    msg += ': ' + (await r.text());
                }
            }catch(_){}
            throw new Error(msg);
        }
        return r.json();
    }
    function toast(msg, ms=1600){
        const t=$('#toast');
        t.textContent=msg;
        t.classList.add('show');
        clearTimeout(toast._tid);
        toast._tid=setTimeout(()=>t.classList.remove('show'), ms);
    }
    function fmtTime(s){ return s ? s.replace('T',' ') : ''; }

    const api = {
        // players
        players: (page,size)=>fetch(`/api/players?page=${page}&size=${size}`).then(j),
        playersAll: ()=>fetch(`/api/players/all`).then(j),
        createPlayer: (name)=>fetch(`/api/players`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerName:name})}).then(j),
        updatePlayer: (playerId, playerName)=>fetch(`/api/players/${encodeURIComponent(playerId)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerName})}).then(j),
        deletePlayer: (playerId)=>fetch(`/api/players/${encodeURIComponent(playerId)}`,{method:'DELETE'}).then(j),
        // rooms
        rooms: (page,size)=>fetch(`/api/rooms?page=${page}&size=${size}`).then(j),
        createRoom: (roomName,x,y,ids)=>fetch(`/api/rooms`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName,mapSizeX:x,mapSizeY:y,joinPlayerIds:ids})}).then(j),
        roomPlayers: (roomId)=>fetch(`/api/rooms/${encodeURIComponent(roomId)}/players`).then(j),
        addRoomPlayers: (roomId, ids)=>fetch(`/api/rooms/${encodeURIComponent(roomId)}/players`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerIds:ids})}).then(j),
        removeRoomPlayer: (roomId, playerId)=>fetch(`/api/rooms/${encodeURIComponent(roomId)}/players/${encodeURIComponent(playerId)}`,{method:'DELETE'}).then(j),
        downloadConfig: ()=>fetch('/api/config/export').then(async r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.blob(); }),
    };

    /* ===== 分页状态 ===== */
    let pPage=1, pSize=10, pTotal=0;
    let rPage=1, rSize=10, rTotal=0;

    /* ===== 当前选中房间 ===== */
    let selectedRoom = null; // { roomId, roomName, mapSizeX, mapSizeY, rounds, isBattle }

    /* ===== 玩家表渲染 ===== */
    function renderPlayers(data){
        pTotal = data.total || 0;
        const tbody = $('#playerTable tbody'); tbody.innerHTML = '';
        (data.list || []).forEach((it, idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${(pPage-1)*pSize + idx + 1}</td>
      <td>${it.playerId || ''}</td>
      <td>${it.playerName || ''}</td>
      <td>${fmtTime(it.createTime) || ''}</td>
      <td>
        <button class="small" data-act="edit" data-id="${it.playerId}" data-name="${it.playerName}">修改</button>
        <button class="small danger" data-act="del" data-id="${it.playerId}" data-name="${it.playerName}">删除</button>
      </td>
    `;
            tbody.appendChild(tr);
        });
        $('#pInfo').textContent = `第 ${pPage} / ${Math.max(1, Math.ceil(pTotal/pSize))} 页，共 ${pTotal} 条`;
    }

    /* ===== 房间表渲染（可选中） ===== */
    function renderRooms(data){
        rTotal = data.total || 0;
        const tbody = $('#roomTable tbody'); tbody.innerHTML = '';
        (data.list || []).forEach((it, idx)=>{
            const tr = document.createElement('tr');
            tr.className = 'selectable' + (selectedRoom && selectedRoom.roomId === it.roomId ? ' active' : '');
            tr.dataset.room = JSON.stringify(it);
            tr.innerHTML = `
      <td>${(rPage-1)*rSize + idx + 1}</td>
      <td>${it.roomId || ''}</td>
      <td>${it.roomName || ''}</td>
      <td>${it.mapSizeX} × ${it.mapSizeY}</td>
      <td>${it.rounds}</td>
      <td>${it.isBattle ? '是' : '否'}</td>
    `;
            tbody.appendChild(tr);
        });
        $('#rInfo').textContent = `第 ${rPage} / ${Math.max(1, Math.ceil(rTotal/rSize))} 页，共 ${rTotal} 条`;
    }

    /* ===== 列表加载 ===== */
    async function loadPlayers(){
        try{
            const data = await api.players(pPage, pSize);
            renderPlayers(data);
        }catch(err){
            console.error(err);
            toast('玩家列表加载失败', 2000);
            throw err;
        }
    }

    async function loadRooms(){
        try{
            const data = await api.rooms(rPage, rSize);
            renderRooms(data);

            const list = data.list || [];
            if(list.length === 0){
                selectedRoom = null;
                showRoomDetail(false);
                $('#roomMembersTable tbody').innerHTML='';
                return;
            }

            if(!selectedRoom || !list.some(r=>r.roomId === selectedRoom.roomId)){
                selectedRoom = list[0];
                highlightSelectedRoom();
                fillRoomDetail(selectedRoom);
                await loadRoomMembers();
            }else{
                highlightSelectedRoom();
            }
        }catch(err){
            console.error(err);
            toast('房间列表加载失败', 2000);
            throw err;
        }
    }

    /* ===== 房间详情面板 ===== */
    function showRoomDetail(show){
        $('#roomDetail').style.display = show ? '' : 'none';
    }
    function highlightSelectedRoom(){
        document.querySelectorAll('#roomTable tbody tr').forEach(tr=>{
            const data = JSON.parse(tr.dataset.room || '{}');
            if(selectedRoom && data.roomId === selectedRoom.roomId){
                tr.classList.add('active');
            }else{
                tr.classList.remove('active');
            }
        });
    }
    function fillRoomDetail(data){
        if(!data){
            showRoomDetail(false);
            return;
        }
        $('#selRoomId').textContent = data.roomId || '';
        $('#selRoomName').textContent = data.roomName || '';
        $('#selRoomSize').textContent = `${data.mapSizeX} × ${data.mapSizeY}`;
        $('#selRoomRounds').textContent = data.rounds;
        $('#selRoomBattle').textContent = data.isBattle ? '是' : '否';
        showRoomDetail(true);
    }
    async function loadRoomMembers(){
        if(!selectedRoom) return;
        const data = await api.roomPlayers(selectedRoom.roomId);
        const tbody = $('#roomMembersTable tbody'); tbody.innerHTML='';
        (data || []).forEach((it, idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${it.playerId}</td>
      <td>${it.playerName}</td>
      <td>${fmtTime(it.entryTime) || ''}</td>
      <td>
        <button class="small danger" data-act="kick" data-id="${it.playerId}">移除</button>
      </td>
    `;
            tbody.appendChild(tr);
        });
    }

    /* ===== 事件绑定：玩家操作（修改/删除） ===== */
    $('#playerTable').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const act = btn.dataset.act, pid = btn.dataset.id, name = btn.dataset.name || '';
        if(act === 'edit'){
            const nv = prompt(`修改玩家名称（${pid}）`, name);
            if(nv && nv.trim()){
                try{ await api.updatePlayer(pid, nv.trim()); toast('玩家已修改'); loadPlayers(); }
                catch(err){ console.error(err); toast('修改失败',2000); }
            }
        }else if(act === 'del'){
            if(confirm(`确认删除玩家【${name}】？此操作会将其从所有房间移除。`)){
                try{ await api.deletePlayer(pid); toast('玩家已删除'); loadPlayers(); if(selectedRoom) loadRoomMembers(); }
                catch(err){ console.error(err); toast('删除失败',2000); }
            }
        }
    });

    /* ===== 事件绑定：房间选择 & 成员移除 ===== */
    $('#roomTable').addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr'); if(!tr) return;
        const data = JSON.parse(tr.dataset.room || '{}');
        selectedRoom = data;
        highlightSelectedRoom();
        fillRoomDetail(data);
        try{ await loadRoomMembers(); }catch(err){ console.error(err); toast('成员加载失败',2000); }
    });

    $('#roomMembersTable').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.act === 'kick'){
            const pid = btn.dataset.id;
            if(confirm('确认将该玩家移出房间？')){
                try{
                    await api.removeRoomPlayer(selectedRoom.roomId, pid);
                    toast('已移除');
                    loadRoomMembers();
                }catch(err){ console.error(err); toast('移除失败',2000); }
            }
        }
    });

    /* ===== 事件绑定：添加成员到房间 ===== */
    const dlgAddMembers = $('#dlgAddMembers');
    $('#btnAddMembers').onclick = async ()=>{
        if(!selectedRoom){ toast('请先选择一个房间'); return; }
        try{
            const [all, inRoom] = await Promise.all([api.playersAll(), api.roomPlayers(selectedRoom.roomId)]);
            const inSet = new Set((inRoom||[]).map(x=>x.playerId));
            const grid = $('#addMemberGrid'); grid.innerHTML='';
            (all||[]).filter(p=>!inSet.has(p.playerId)).forEach(p=>{
                const label = document.createElement('label');
                label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';
                label.innerHTML = `<input type="checkbox" value="${p.playerId}"><span>${p.playerName}</span>`;
                grid.appendChild(label);
            });
            if(grid.children.length === 0){
                grid.innerHTML = `<div class="muted">没有可添加的玩家</div>`;
            }
            dlgAddMembers.showModal();
        }catch(err){ console.error(err); toast('加载可添加玩家失败',2000); }
    };
    dlgAddMembers.addEventListener('close', async ()=>{
        if(dlgAddMembers.returnValue === 'ok'){
            const ids = Array.from(document.querySelectorAll('#addMemberGrid input[type=checkbox]:checked')).map(i=>i.value);
            if(ids.length === 0){ toast('未选择玩家'); return; }
            try{
                await api.addRoomPlayers(selectedRoom.roomId, ids);
                toast('已添加');
                loadRoomMembers();
            }catch(err){ console.error(err); toast('添加失败',2000); }
        }
    });
    $('#btnReloadMembers').onclick = ()=>selectedRoom && loadRoomMembers();

    /* ===== 设置弹窗 ===== */
    const dlgSettings = $('#dlgSettings');
    $('#btnSettings').onclick = ()=>{ dlgSettings.showModal(); };
    const btnDownloadConfig = $('#btnDownloadConfig');
    btnDownloadConfig.addEventListener('click', async ()=>{
        if(btnDownloadConfig.disabled) return;
        const original = btnDownloadConfig.textContent;
        btnDownloadConfig.textContent = '生成中...';
        btnDownloadConfig.disabled = true;
        try{
            const blob = await api.downloadConfig();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.db';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            toast('配置文件已下载');
        }catch(err){
            console.error(err);
            toast('下载失败', 2000);
        }finally{
            btnDownloadConfig.disabled = false;
            btnDownloadConfig.textContent = original;
        }
    });

    /* ===== 创建玩家 ===== */
    const dlgPlayer = $('#dlgPlayer');
    $('#btnCreatePlayer').onclick = ()=>{ $('#playerName').value=''; dlgPlayer.showModal(); };
    dlgPlayer.addEventListener('close', async ()=>{
        if(dlgPlayer.returnValue === 'ok'){
            const name = ($('#playerName').value || '').trim();
            if(!name){ toast('玩家名称不能为空'); return; }
            try{ await api.createPlayer(name); toast('创建玩家成功'); pPage=1; loadPlayers(); }
            catch(err){ console.error(err); toast('创建玩家失败',2000); }
        }
    });

    /* ===== 创建房间 ===== */
    const dlgRoom = $('#dlgRoom');
    $('#btnCreateRoom').onclick = async ()=>{
        $('#roomName').value=''; $('#mapX').value='10'; $('#mapY').value='10';
        try{
            const players = await api.playersAll();
            const grid = $('#playerGrid'); grid.innerHTML='';
            (players||[]).forEach(p=>{
                const label = document.createElement('label');
                label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';
                label.innerHTML = `<input type="checkbox" value="${p.playerId}"><span>${p.playerName}</span>`;
                grid.appendChild(label);
            });
            dlgRoom.showModal();
        }catch(err){ console.error(err); toast('加载玩家失败',2000); }
    };
    dlgRoom.addEventListener('close', async ()=>{
        if(dlgRoom.returnValue === 'ok'){
            const name = ($('#roomName').value || '').trim();
            const x = parseInt($('#mapX').value,10);
            const y = parseInt($('#mapY').value,10);
            if(!name){ toast('房间名称不能为空'); return; }
            if(!(x>0 && y>0)){ toast('地图尺寸必须大于0'); return; }
            const ids = Array.from(document.querySelectorAll('#playerGrid input[type=checkbox]:checked')).map(i=>i.value);
            try{
                await api.createRoom(name,x,y,ids);
                toast('创建房间成功');
                rPage=1; await loadRooms();
            }catch(err){ console.error(err); toast('创建房间失败',2000); }
        }
    });

    /* ===== 分页/刷新 ===== */
    $('#pPrev').onclick = ()=>{ if(pPage>1){ pPage--; loadPlayers(); } };
    $('#pNext').onclick = ()=>{ if(pPage*pSize<pTotal){ pPage++; loadPlayers(); } };
    $('#pRefresh').onclick = loadPlayers;

    $('#rPrev').onclick = ()=>{ if(rPage>1){ rPage--; loadRooms(); } };
    $('#rNext').onclick = ()=>{ if(rPage*rSize<rTotal){ rPage++; loadRooms(); } };
    $('#rRefresh').onclick = loadRooms;

    $('#btnRefresh').onclick = ()=>{ loadPlayers(); loadRooms(); if(selectedRoom) loadRoomMembers(); };

    /* ===== 初始加载 ===== */
    async function init(){ await Promise.all([loadPlayers(), loadRooms()]); }
    init();
</script>
</body>
</html>
